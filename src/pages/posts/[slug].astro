---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { encrypt } from '../../utils/crypto';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    return data.draft !== true;
  });

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: any;
}

// è®¡ç®—æ–‡ç« å­—æ•°
const countWords = (content: string) => {
  // ç§»é™¤Markdownè¯­æ³•
  const text = content
    .replace(/\n/g, ' ')
    .replace(/\*\*(.*?)\*\*/g, '$1')
    .replace(/\*(.*?)\*/g, '$1')
    .replace(/`(.*?)`/g, '$1')
    .replace(/#{1,6}\s/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[.*?\]\(.*?\)/g, '$1')
    .trim();
  return text.length > 0 ? text.length : 0;
};

const { post } = Astro.props;
const isEncrypted = post.data.encrypt === true;
const encryptionHint = post.data.aes_key_hint;

// ä½¿ç”¨æ–‡ç«  front-matter ä¸­å®šä¹‰çš„å¯†é’¥æ¥åŠ å¯†å†…å®¹
// å¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å¯†é’¥
const ENCRYPTION_KEY = post.data.aes_key || 'default-key';

// æ¸²æŸ“å¹¶åŠ å¯†æ–‡ç« å†…å®¹
let encryptedContent = '';
if (isEncrypted) {
  // ç›´æ¥åŠ å¯†æ–‡ç« çš„åŸå§‹Markdownå†…å®¹
  // è¿™æ ·æ„å»ºäº§ç‰©ä¸­åªä¼šåŒ…å«åŠ å¯†åçš„å†…å®¹ï¼Œä¸ä¼šåŒ…å«æ˜æ–‡
  encryptedContent = encrypt(post.body, ENCRYPTION_KEY);
}

// å¯¹äºåŠ å¯†æ–‡ç« ï¼Œæˆ‘ä»¬ä¸æ¸²æŸ“Contentç»„ä»¶
// è¿™æ ·æ˜æ–‡å†…å®¹å°±ä¸ä¼šå‡ºç°åœ¨æ„å»ºäº§ç‰©ä¸­
let Content = null;
if (!isEncrypted) {
  const rendered = await post.render();
  Content = rendered.Content;
}
---

<BaseLayout title={post.data.title}>
  <article>
    <h1>{post.data.title}</h1>
    <div class="post-meta">
      {new Date(post.data.date).toLocaleDateString('zh-CN')} Â· {countWords(post.body)} å­—
    </div>
    
    {isEncrypted ? (
      <div id="encrypted-content">
        <div class="encryption-container">
          <div class="encryption-icon">ğŸ”’</div>
          <h2>æ–‡ç« å·²åŠ å¯†</h2>
          {encryptionHint && (
            <p class="encryption-hint">{encryptionHint}</p>
          )}
          <form id="decryption-form" novalidate>
            <div class="input-group">
              <input 
                type="password" 
                id="decryption-key" 
                placeholder="è¯·è¾“å…¥è§£å¯†å¯†ç "
              />
              <button type="submit" class="decrypt-btn">
                <span class="btn-text">è§£å¯†</span>
                <span class="btn-loading" style="display: none;">åŠ è½½ä¸­...</span>
              </button>
            </div>
          </form>
        </div>
        <div id="decrypted-content" style="display: none;">
          <!-- è§£å¯†åçš„å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
        </div>
      </div>
    ) : (
      <Content />
    )}
    
    <!-- å¼¹çª—æç¤º -->
    <div id="notification-popup" class="notification-popup">
      <div class="notification-content">
        <div class="notification-icon">
          <svg class="success-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <svg class="error-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </div>
        <p class="notification-message"></p>
      </div>
    </div>
  
  <!-- Back to Top Button -->
  <button aria-label="Back to Top" class="back-to-top">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
  </button>

  <style scoped>
    /* Back to Top Button Styles */
    .back-to-top {
      position: fixed;
      background-color: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      z-index: 1000;
      height: 3.5rem;
      width: 3.5rem;
    }

    /* å¤§å±å¹•ï¼šæŒ‰é’®ä½äºå®¹å™¨å³ä¾§ */
    @media (min-width: 841px) {
      .back-to-top {
        right: calc(50% - 400px - 1rem);
        bottom: 2rem;
      }
    }

    /* ä¸­ç­‰å±å¹•ï¼šæŒ‰é’®ä½äºçª—å£å³ä¾§ */
    @media (max-width: 840px) {
      .back-to-top {
        right: 1.5rem;
        bottom: 2rem;
      }
    }

    /* å°å±å¹•ï¼šæŒ‰é’®ä½äºçª—å£å³ä¾§ï¼Œå°ºå¯¸å‡å° */
    @media (max-width: 480px) {
      .back-to-top {
        right: 1rem;
        bottom: 1rem;
        height: 3rem;
        width: 3rem;
      }
    }

    .back-to-top:hover {
      background-color: var(--accent-color);
      color: var(--bg-color);
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* åŠ å¯†ç›¸å…³æ ·å¼ */
    .encryption-container {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 3rem 2rem;
      margin: 3rem 0;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .encryption-container:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
    }
    
    .encryption-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      animation: pulse 2s infinite;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--accent-color);
      margin-bottom: 2rem;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    .encryption-container h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text-color);
      font-size: 1.75rem;
      font-weight: 700;
      font-family: var(--font-sans);
      letter-spacing: -0.02em;
    }
    
    .encryption-hint {
      color: var(--text-color-secondary);
      margin-bottom: 2.5rem;
      font-style: italic;
      font-size: 1.1rem;
      line-height: 1.6;
      font-family: var(--font-serif);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    #decryption-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .input-group {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    
    #decryption-key {
      flex: 1;
      padding: 1rem 1.25rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    #decryption-key:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .decrypt-btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      background-color: var(--accent-color);
      color: var(--bg-color);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 120px;
    }
    
    .decrypt-btn:hover {
      background-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .decrypt-btn:active {
      transform: translateY(0);
    }
    
    .decrypt-btn:disabled {
      background-color: var(--border-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    

    
    /* å¼¹çª—æç¤ºæ ·å¼ */
    .notification-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      z-index: 10000;
      max-width: 300px;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .notification-popup.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }
    
    .notification-content {
      background-color: rgba(255, 255, 255, 0.95);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: fadeInScale 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .notification-icon {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
    }
    
    .success-icon {
      display: none;
      color: #28a745;
    }
    
    .error-icon {
      display: none;
      color: #dc3545;
    }
    
    .notification-icon.success .success-icon {
      display: block;
    }
    
    .notification-icon.error .error-icon {
      display: block;
    }
    
    .notification-message {
      margin: 0;
      color: #333333;
      font-size: 14px;
      line-height: 1.4;
      font-weight: 400;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* æ·±è‰²æ¨¡å¼é€‚é… */
    @media (prefers-color-scheme: dark) {
      .notification-content {
        background-color: rgba(30, 30, 30, 0.95);
        border: 1px solid #404040;
      }
      
      .notification-message {
        color: #f0f0f0;
      }
    }
    
    [data-theme="dark"] .notification-content {
      background-color: rgba(30, 30, 30, 0.95);
      border: 1px solid #404040;
    }
    
    [data-theme="dark"] .notification-message {
      color: #f0f0f0;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 600px) {
      .encryption-container {
        padding: 2rem 1.5rem;
        margin: 2rem 0;
      }
      
      .input-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .decrypt-btn {
        width: 100%;
      }
      
      .notification-popup {
        max-width: 90%;
      }
    }
    
    /* è§£å¯†åçš„å†…å®¹åŠ¨ç”» */
    #decrypted-content {
      animation: fadeInUp 0.8s ease-out;
    }
  </style>

  <script>
    // Back to Top Button Functionality
    const backToTopButton = document.querySelector('.back-to-top') as HTMLElement | null;
    
    if (backToTopButton) {
      // Show/hide button based on scroll position
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTopButton.style.display = 'flex';
        } else {
          backToTopButton.style.display = 'none';
        }
      });
      
      // Scroll to top when button is clicked
      backToTopButton.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
      
      // Initially hide button
      backToTopButton.style.display = 'none';
    }
  </script>

  {isEncrypted && (
    <>
      <!-- å­˜å‚¨åŠ å¯†å†…å®¹çš„éšè—å…ƒç´  -->
      <div id="encrypted-content-storage" style="display: none;">{encryptedContent}</div>
      
      <script>
        // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ (IIFE) å°è£…è„šæœ¬ï¼Œé¿å…å˜é‡åå†²çª
        (function() {
          // è§£å¯†åŠŸèƒ½
          const decryptionForm = document.getElementById('decryption-form');
          const decryptionKey = document.getElementById('decryption-key') as HTMLInputElement | null;
          const encryptedContainer = document.querySelector('.encryption-container') as HTMLElement | null;
          const decryptedContent = document.getElementById('decrypted-content') as HTMLElement | null;
          const decryptBtn = document.querySelector('.decrypt-btn') as HTMLButtonElement | null;
          const btnText = document.querySelector('.btn-text') as HTMLElement | null;
          const btnLoading = document.querySelector('.btn-loading') as HTMLElement | null;
          
          // ä»éšè—å…ƒç´ è·å–åŠ å¯†çš„å†…å®¹
          const encryptedContentStorage = document.getElementById('encrypted-content-storage');
          const encryptedContentFromServer = encryptedContentStorage ? encryptedContentStorage.textContent : '';
          
          // å¼¹çª—æç¤ºåŠŸèƒ½
          function showNotification(message: string, type: 'success' | 'error') {
            const notification = document.getElementById('notification-popup');
            const notificationIcon = notification?.querySelector('.notification-icon');
            const notificationMessage = notification?.querySelector('.notification-message');
            
            if (notification && notificationIcon && notificationMessage) {
              // è®¾ç½®æ¶ˆæ¯å†…å®¹å’Œç±»å‹
              notificationMessage.textContent = message;
              notificationIcon.className = `notification-icon ${type}`;
              
              // æ˜¾ç¤ºå¼¹çª—
              notification.classList.add('show');
              
              // 3ç§’åè‡ªåŠ¨éšè—
              setTimeout(() => {
                notification.classList.remove('show');
              }, 3000);
            }
          }
          
          // è®¾ç½®åŠ è½½çŠ¶æ€
          function setLoadingState(isLoading: boolean) {
            if (decryptBtn && btnText && btnLoading) {
              decryptBtn.disabled = isLoading;
              
              if (isLoading) {
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                decryptBtn.style.opacity = '0.7';
              } else {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                decryptBtn.style.opacity = '1';
              }
            }
          }
          
          if (decryptionForm && decryptionKey && encryptedContainer && decryptedContent && encryptedContentFromServer) {
            decryptionForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              
              const password = decryptionKey.value.trim();
              if (!password) {
                showNotification('è¯·è¾“å…¥å¯†ç ', 'error');
                return;
              }
              
              try {
                // è®¾ç½®åŠ è½½çŠ¶æ€
                setLoadingState(true);
                
                // ä½¿ç”¨ Web Crypto API è¿›è¡Œè§£å¯†
                const decryptedText = await decryptWithWebCrypto(encryptedContentFromServer, password);
                
                // éªŒè¯è§£å¯†æ˜¯å¦æˆåŠŸï¼ˆç®€å•æ£€æŸ¥ï¼‰
                if (!decryptedText || decryptedText.length < 10) {
                  throw new Error('è§£å¯†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®');
                }
                
                // è§£æ Markdown å¹¶æ˜¾ç¤ºå†…å®¹
                decryptedContent.innerHTML = await markdownToHtml(decryptedText);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification('è§£å¯†æˆåŠŸï¼', 'success');
                
                // æ˜¾ç¤ºè§£å¯†åçš„å†…å®¹
                encryptedContainer.style.display = 'none';
                decryptedContent.style.display = 'block';
                
                // è§¦å‘å†…å®¹è¿›å…¥åŠ¨ç”»
                decryptedContent.style.opacity = '0';
                decryptedContent.style.transform = 'translateY(20px)';
                
                requestAnimationFrame(() => {
                  decryptedContent.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                  decryptedContent.style.opacity = '1';
                  decryptedContent.style.transform = 'translateY(0)';
                });
                
              } catch (error) {
                showNotification('è§£å¯†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®', 'error');
                console.error('è§£å¯†é”™è¯¯:', error);
              } finally {
                // é‡ç½®åŠ è½½çŠ¶æ€
                setLoadingState(false);
              }
            });
          }
          
          // Web Crypto API è§£å¯†å‡½æ•°
          async function decryptWithWebCrypto(encryptedText: string, password: string): Promise<string> {
            try {
              const [ivBase64, encryptedData] = encryptedText.split(':');
              const iv = new Uint8Array(atob(ivBase64).split('').map(c => c.charCodeAt(0)));
              const encrypted = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
              
              // ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
              const keyMaterial = await crypto.subtle.importKey(
                'raw',
                new TextEncoder().encode(password),
                { name: 'PBKDF2' },
                false,
                ['deriveKey']
              );
              
              const key = await crypto.subtle.deriveKey(
                {
                  name: 'PBKDF2',
                  salt: new TextEncoder().encode('won-blog-salt'),
                  iterations: 100000,
                  hash: 'SHA-256'
                },
                keyMaterial,
                {
                  name: 'AES-CBC',
                  length: 256
                },
                false,
                ['decrypt']
              );
              
              // è§£å¯†
              const decrypted = await crypto.subtle.decrypt(
                {
                  name: 'AES-CBC',
                  iv: iv
                },
                key,
                encrypted
              );
              
              return new TextDecoder().decode(decrypted);
            } catch (error) {
              throw new Error('è§£å¯†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®');
            }
          }
          
          // ç®€å•çš„ Markdown è§£æå‡½æ•°
          async function markdownToHtml(markdown: string): Promise<string> {
            // åŸºæœ¬çš„ Markdown è§£æ
            let html = markdown
              // æ ‡é¢˜
              .replace(/^### (.*$)/gim, '<h3>$1</h3>')
              .replace(/^## (.*$)/gim, '<h2>$1</h2>')
              .replace(/^# (.*$)/gim, '<h1>$1</h1>')
              // ç²—ä½“
              .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
              // æ–œä½“
              .replace(/\*(.*?)\*/gim, '<em>$1</em>')
              // åˆ—è¡¨
              .replace(/^\- (.*$)/gim, '<li>$1</li>')
              .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
              // æ®µè½
              .replace(/^(?!<[h1-6ulli])(.*$)/gim, '<p>$1</p>')
              // ç©ºè¡Œ
              .replace(/\n\n/gim, '</p><p>')
              .replace(/<p><\/p>/gim, '');
            
            return html;
          }
        })();
      </script>
    </>
  )}
</BaseLayout>