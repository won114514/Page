---
import { config } from '@/config';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('posts', ({ data }) => {
  return data.draft !== true;
});

// 按日期倒序排序
posts.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

// 计算文章字数
const countWords = (content: string) => {
  // 移除Markdown语法
  const text = content
    .replace(/\n/g, ' ')
    .replace(/\*\*(.*?)\*\*/g, '$1')
    .replace(/\*(.*?)\*/g, '$1')
    .replace(/`(.*?)`/g, '$1')
    .replace(/#{1,6}\s/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[.*?\]\(.*?\)/g, '$1')
    .trim();
  return text.length > 0 ? text.length : 0;
};
---

<BaseLayout title={`文章列表 - ${config.title}`}>
  <h1>文章列表</h1>
  <ul class="post-list">
    {posts.map((post) => (
      <li class="post-item">
        <h2><a href={`/posts/${post.slug}`}>{post.data.title}</a></h2>
        <div class="post-meta">
          {new Date(post.data.date).toLocaleDateString('zh-CN')} · {countWords(post.body)} 字
        </div>
        {post.data.excerpt && (
          <p class="post-excerpt">{post.data.excerpt}</p>
        )}
      </li>
    ))}
  </ul>
</BaseLayout>
