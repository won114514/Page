---
import { config } from '@/config';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 获取所有非草稿文章
const allPosts = await getCollection('posts', ({ data }) => {
  return data.draft !== true;
});

// 按日期倒序排序
allPosts.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

// 分页配置
const postsPerPage = 5;

// 只显示第一页
const currentPage = 1;

// 计算总页数
const totalPages = Math.ceil(allPosts.length / postsPerPage);

// 计算当前页显示的文章
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = allPosts.slice(startIndex, endIndex);

// 计算文章字数
const countWords = (content: string) => {
  // 移除Markdown语法
  const text = content
    .replace(/\n/g, ' ')
    .replace(/\*\*(.*?)\*\*/g, '$1')
    .replace(/\*(.*?)\*\*/g, '$1')
    .replace(/\*(.*?)\*/g, '$1')
    .replace(/`(.*?)`/g, '$1')
    .replace(/#{1,6}\s/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[.*?\]\(.*?\)/g, '$1')
    .trim();
  return text.length > 0 ? text.length : 0;
};

// 生成页码链接
const getPageUrl = (pageNumber: number) => {
  if (pageNumber === 1) {
    return '/';
  }
  return `/${pageNumber}`;
};
---

<BaseLayout title={`文章列表 - ${config.title}`}>
  <h1>文章列表</h1>
  <ul class="post-list">
    {posts.map((post) => (
      <li class="post-item">
        <h2><a href={`/posts/${post.slug}`}>{post.data.title}</a></h2>
        <div class="post-meta">
          {new Date(post.data.date).toLocaleDateString('zh-CN')} · {countWords(post.body)} 字
        </div>
        {post.data.excerpt && (
          <p class="post-excerpt">{post.data.excerpt}</p>
        )}
      </li>
    ))}
  </ul>
  
  <!-- 分页导航 -->
  {totalPages > 1 && (
    <nav class="pagination">
      <ul class="pagination-list">
        <!-- 页码 -->
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
          <li class={`pagination-item ${currentPage === pageNum ? 'active' : ''}`}>
            <a href={getPageUrl(pageNum)} class="pagination-link">
              {pageNum}
            </a>
          </li>
        ))}
        
        <!-- 下一页 -->
        {currentPage < totalPages && (
          <li class="pagination-item">
            <a href={getPageUrl(currentPage + 1)} class="pagination-link next">
              下一页
            </a>
          </li>
        )}
      </ul>
    </nav>
  )}
</BaseLayout>

<style>
  /* 分页样式 */
  .pagination {
    margin-top: 2rem;
    text-align: center;
    padding: 1rem 0;
  }
  
  .pagination-list {
    display: flex;
    justify-content: center;
    align-items: center;
    list-style: none;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
  }
  
  .pagination-item {
    margin: 0;
  }
  
  .pagination-link {
    display: inline-block;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--bg-color);
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }
  
  .pagination-link:hover {
    background-color: var(--border-color);
    border-color: var(--accent-color);
    text-decoration: none;
  }
  
  .pagination-item.active .pagination-link {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border-color: var(--accent-color);
  }
  
  .pagination-link.prev, .pagination-link.next {
    padding: 0.5rem 1.25rem;
  }
  
  /* 响应式设计 */
  @media (max-width: 600px) {
    .pagination-list {
      gap: 0.25rem;
    }
    
    .pagination-link {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
  }
</style>
