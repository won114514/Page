---
import { config } from '@/config';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 预生成所有年份和页码的静态页面
export async function getStaticPaths() {
  // 获取所有非草稿文章
  const allPosts = await getCollection('posts', ({ data }) => {
    return data.draft !== true;
  });

  // 按日期倒序排序
  allPosts.sort((a, b) => {
    const dateA = new Date(a.data.date);
    const dateB = new Date(b.data.date);
    return dateB.getTime() - dateA.getTime();
  });

  // 提取所有不重复的年份
  const years = Array.from(new Set(allPosts.map(post => new Date(post.data.date).getFullYear().toString())));
  
  // 分页配置
  const postsPerPage = 5;
  
  // 生成所有年份和页码的路径
  const paths: { params: { year: string; page: string }; props: { year: string; page: number } }[] = [];
  
  for (const year of years) {
    // 筛选当前年份的文章
    const yearPosts = allPosts.filter(post => {
      return new Date(post.data.date).getFullYear().toString() === year;
    });
    
    // 计算总页数
    const totalPages = Math.ceil(yearPosts.length / postsPerPage);
    
    // 生成当前年份的所有页码路径
    for (let page = 1; page <= totalPages; page++) {
      paths.push({
        params: { year, page: page.toString() }, // 动态参数
        props: { year, page }, // 传递年份和页码作为 props
      });
    }
  }
  
  return paths;
}

// 获取当前年份和页码
const { year: currentYear, page: currentPage } = Astro.props as { year: string; page: number };

// 获取所有非草稿文章
const allPosts = await getCollection('posts', ({ data }) => {
  return data.draft !== true;
});

// 按日期倒序排序
allPosts.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

// 筛选当前年份的文章
const yearPosts = allPosts.filter(post => {
  return new Date(post.data.date).getFullYear().toString() === currentYear;
});

// 分页配置
const postsPerPage = 5;

// 计算总页数
const totalPages = Math.ceil(yearPosts.length / postsPerPage);

// 计算当前页显示的文章
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = yearPosts.slice(startIndex, endIndex);

// 按年份分组当前页的文章（只有一个年份）
const postsByYear: Record<string, typeof posts> = {
  [currentYear]: posts
};

// 计算文章字数
const countWords = (content: string) => {
  const text = content
    .replace(/\n/g, ' ')
    .replace(/\*\*(.*?)\*\*/g, '$1')
    .replace(/\*(.*?)\*/g, '$1')
    .replace(/`(.*?)`/g, '$1')
    .replace(/#{1,6}\s/g, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[.*?\]\(.*?\)/g, '$1')
    .trim();
  return text.length > 0 ? text.length : 0;
};

// 生成页码链接
const getPageUrl = (pageNumber: number) => {
  if (pageNumber === 1) {
    return `/archive/${currentYear}`;
  }
  return `/archive/${currentYear}/${pageNumber}`;
};
---

<BaseLayout title={`${currentYear}年文章归档 - 第${currentPage}页 - ${config.title}`}>
  <div class="back-link-container">
    <a href="/archive" class="back-link">
      ← 返回归档首页
    </a>
  </div>
  <h1>{currentYear}年文章归档 - 第{currentPage}页</h1>
  
  <div class="archive-container">
    {Object.entries(postsByYear).map(([year, yearPosts]) => (
      <div class="archive-year">
        <h2 class="archive-year-title">{year}</h2>
        <ul class="archive-posts">
          {yearPosts.map(post => (
            <li class="archive-post-item">
              <div class="archive-post-header">
                <a href={`/posts/${post.slug}`} class="archive-post-title">{post.data.title}</a>
              </div>
              <div class="archive-post-meta">
                <span class="archive-post-date">{new Date(post.data.date).toLocaleDateString('zh-CN')}</span>
                <span class="archive-post-word-count">{countWords(post.body)} 字</span>
              </div>
              {post.data.excerpt && (
                <p class="archive-post-excerpt">{post.data.excerpt}</p>
              )}
            </li>
          ))}
        </ul>
      </div>
    ))}
  </div>
  
  <!-- 分页导航 -->
  {totalPages > 1 && (
    <nav class="pagination">
      <ul class="pagination-list">
        <!-- 上一页 -->
        {currentPage > 1 && (
          <li class="pagination-item">
            <a href={getPageUrl(currentPage - 1)} class="pagination-link prev">
              上一页
            </a>
          </li>
        )}
        
        <!-- 页码 -->
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
          <li class={`pagination-item ${currentPage === pageNum ? 'active' : ''}`}>
            <a href={getPageUrl(pageNum)} class="pagination-link">
              {pageNum}
            </a>
          </li>
        ))}
        
        <!-- 下一页 -->
        {currentPage < totalPages && (
          <li class="pagination-item">
            <a href={getPageUrl(currentPage + 1)} class="pagination-link next">
              下一页
            </a>
          </li>
        )}
      </ul>
    </nav>
  )}
</BaseLayout>

<style scoped>
  .archive-container {
    margin-top: 2rem;
  }

  .archive-year {
    margin-bottom: 2rem;
  }

  .archive-year-title {
    font-size: 1.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .archive-posts {
    list-style: none;
  }

  .archive-post-item {
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-color);
  }

  .archive-post-item:last-child {
    border-bottom: none;
  }

  .archive-post-header {
    margin-bottom: 0.5rem;
  }

  .archive-post-title {
    font-size: 1.1rem;
    font-weight: 500;
  }

  .archive-post-meta {
    font-size: 0.85rem;
    color: var(--text-color);
    opacity: 0.7;
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .archive-post-excerpt {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
    margin: 0;
    line-height: 1.5;
  }
  
  /* 分页样式 */
  .pagination {
    margin-top: 2rem;
    text-align: center;
    padding: 1rem 0;
  }
  
  .pagination-list {
    display: flex;
    justify-content: center;
    align-items: center;
    list-style: none;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
  }
  
  .pagination-item {
    margin: 0;
  }
  
  .pagination-link {
    display: inline-block;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--bg-color);
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }
  
  .pagination-link:hover {
    background-color: var(--border-color);
    border-color: var(--accent-color);
    text-decoration: none;
  }
  
  .pagination-item.active .pagination-link {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border-color: var(--accent-color);
  }
  
  .pagination-link.prev, .pagination-link.next {
    padding: 0.5rem 1.25rem;
  }
  
  /* 响应式设计 */
  @media (max-width: 600px) {
    .pagination-list {
      gap: 0.25rem;
    }
    
    .pagination-link {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
  }
</style>