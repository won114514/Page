---
import { config } from '@/config';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 获取所有非草稿文章
const allPosts = await getCollection('posts', ({ data }) => {
  return data.draft !== true;
});

// 按日期倒序排序
allPosts.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

// 提取所有不重复的年份并按降序排序
const years = Array.from(new Set(allPosts.map(post => new Date(post.data.date).getFullYear()))).sort((a, b) => b - a);

// 分页配置
const postsPerPage = 5;

// 只显示第一页
const currentPage = 1;

// 计算当前页显示的文章
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = allPosts.slice(startIndex, endIndex);

// 按年份分组当前页的文章
const postsByYear: Record<string, typeof posts> = {};
posts.forEach(post => {
  const year = new Date(post.data.date).getFullYear();
  if (!postsByYear[year]) {
    postsByYear[year] = [];
  }
  postsByYear[year].push(post);
});
---

<BaseLayout title={`归档 - ${config.title}`}>
  <h1>文章归档</h1>
  
  <p class="archive-intro">请选择以下年份查看对应文章：</p>
  
  <!-- 年份导航 -->
  <div class="year-navigation">
    <h2>按年份浏览</h2>
    <div class="year-links">
      {years.map(year => (
        <a href={`/archive/${year}`} class="year-link">
          {year}年
        </a>
      ))}
    </div>
  </div>
  
  <div class="archive-stats">
    <p>共有 <strong>{allPosts.length}</strong> 篇文章，分布在 <strong>{years.length}</strong> 个年份中。</p>
  </div>

  <style scoped>
    /* 年份导航样式 */
    .year-navigation {
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: rgba(var(--border-color), 0.1);
      border-radius: 8px;
    }
    
    .year-navigation h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--text-color);
    }
    
    .year-links {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .year-link {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-color);
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .year-link:hover {
      background-color: var(--border-color);
      border-color: var(--accent-color);
      text-decoration: none;
    }
    
    .archive-intro {
      margin-bottom: 2rem;
      font-size: 1.1rem;
      color: var(--text-color);
      opacity: 0.8;
    }
    
    .archive-stats {
      margin-top: 2rem;
      padding: 1rem;
      background-color: rgba(var(--border-color), 0.1);
      border-radius: 8px;
      font-size: 0.95rem;
      color: var(--text-color);
      opacity: 0.9;
    }
    
    /* 响应式设计 */
    @media (max-width: 600px) {
      .year-links {
        gap: 0.5rem;
      }
      
      .year-link {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }
    }
  </style>
</BaseLayout>