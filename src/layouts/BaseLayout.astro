---
import ThemeToggle from '../components/ThemeToggle.astro';
import LoadingIndicator from '../components/LoadingIndicator.astro';
import Search from '../components/Search.astro';
import RightClickMenu from '../components/RightClickMenu.astro';
import { config } from '../config';

interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- MathJax 将在需要时懒加载 -->
    
    <!-- 内联脚本：在CSS加载前设置主题，避免白色闪烁 -->
    <script>
      (function() {
        // 在CSS加载前设置主题
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
    
    <style is:global>@import url('src/styles/main.css');</style>
  </head>
  <body>
    <!-- 加载指示器 -->
    <LoadingIndicator />
    <!-- 自定义右键菜单 -->
    <RightClickMenu />
    
    <div class="container">
      <header>
        <nav class="nav-container">
          <h1 class="site-title"><a href="/">{config.title}</a></h1>
          <div class="nav-links">
            <a href="/" class="nav-link">首页</a>
            <a href="/archive" class="nav-link">归档</a>
            <a href="/notifications" class="nav-link">通知</a>
            <a href="/sponsors" class="nav-link">赞助</a>
            <a href="/rss" class="nav-link">RSS</a>
          </div>
          <Search />
          <ThemeToggle />
        </nav>
      </header>
      <main>
        <slot />
      </main>
      <footer>
        <p>© {new Date().getFullYear()} {config.title}. All rights reserved.</p>
        <p class="beian-info">
          <img src="/favicon/foot-icp.png" alt="ICP备案图标" class="beian-icon" width="16" height="16" />
          <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer">粤ICP备2024334045号-1</a>
          <br />
          <img src="/favicon/foot-ga.png" alt="公安备案图标" class="beian-icon" width="14" height="16" />
          <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44200002445547" target="_blank" rel="noopener noreferrer">粤公网安备44200002445547号</a>
        </p>
      </footer>
    </div>

    <!-- 客户端导航优化脚本 -->
    <script>
      // 统一清理所有加载元素
      function cleanUpLoadingElements() {
        const loadingOverlay = document.querySelector('.loading-overlay') as HTMLElement;
        if (loadingOverlay) {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 300);
        }

        const transitionOverlay = document.querySelector('.page-transition-overlay');
        if (transitionOverlay) {
          transitionOverlay.remove();
        }
      }

      // 隐藏加载指示器（向后兼容）
      function hideLoadingIndicator() {
        cleanUpLoadingElements();
      }

      // 显示加载指示器
      function showLoadingIndicator() {
        const loadingOverlay = document.querySelector('.loading-overlay') as HTMLElement;
        if (loadingOverlay) {
          (loadingOverlay as HTMLElement).style.display = 'flex';
          setTimeout(() => {
            (loadingOverlay as HTMLElement).style.opacity = '0.8';
          }, 10);
        }
      }

      // 初始化：在多种页面加载时机都清理加载元素
      function initializePage() {
        cleanUpLoadingElements();
      }

      // 页面DOM内容加载完成时清理
      document.addEventListener('DOMContentLoaded', initializePage);

      // 页面完全加载完成时清理
      window.addEventListener('load', initializePage);

      // 处理浏览器返回按钮的情况
      window.addEventListener('pageshow', (e) => {
        // 当从浏览器缓存中加载页面时（如使用返回按钮），清理所有加载元素
        initializePage();
      });

      // 页面切换时显示加载指示器
      window.addEventListener('beforeunload', () => {
        showLoadingIndicator();
      });

      // 拦截同域链接点击，实现平滑导航和页面过渡动画
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target) {
          const anchor = target.closest('a') as HTMLAnchorElement;
          if (
            anchor && 
            anchor.tagName === 'A' && 
            anchor.origin === window.location.origin &&
            !anchor.getAttribute('target') &&
            !e.ctrlKey &&
            !e.metaKey &&
            !e.shiftKey
          ) {
            // 检查是否是锚点链接（页面内导航）
            const isAnchorLink = anchor.href.includes('#') && anchor.pathname === window.location.pathname;
            
            if (isAnchorLink) {
              // 对于锚点链接，实现平滑滚动
              e.preventDefault();
              
              // 提取锚点目标
              const hash = anchor.hash;
              if (hash) {
                const targetElement = document.querySelector(hash);
                if (targetElement) {
                  // 平滑滚动到目标位置
                  targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start',
                    inline: 'nearest'
                  });
                  
                  // 更新URL哈希，保持浏览器历史记录
                  history.pushState(null, '', hash);
                }
              }
            } else {
              // 如果不是锚点链接，显示页面过渡动画
              e.preventDefault();
              
              // 创建并显示页面过渡动画
              const transitionOverlay = document.createElement('div');
              transitionOverlay.className = 'page-transition-overlay';
              transitionOverlay.style.position = 'fixed';
              transitionOverlay.style.top = '0';
              transitionOverlay.style.left = '0';
              transitionOverlay.style.width = '100%';
              transitionOverlay.style.height = '100%';
              transitionOverlay.style.backgroundColor = 'var(--bg-color)';
              transitionOverlay.style.zIndex = '9999';
              transitionOverlay.style.opacity = '0';
              transitionOverlay.style.transition = 'opacity 400ms cubic-bezier(0.4, 0, 0.2, 1)';
              document.body.appendChild(transitionOverlay);
              
              // 触发动画
              requestAnimationFrame(() => {
                transitionOverlay.style.opacity = '1';
              });
              
              // 动画完成后导航
              setTimeout(() => {
                window.location.href = anchor.href;
              }, 400);
            }
          }
        }
      });



      // 资源预加载：预加载导航链接的资源
      const preloadLinks = () => {
        const links = document.querySelectorAll('a.nav-link');
        links.forEach((link) => {
          const preloadLink = document.createElement('link');
          preloadLink.rel = 'prefetch';
          preloadLink.href = (link as HTMLAnchorElement).href;
          document.head.appendChild(preloadLink);
        });
      };

      // 页面空闲时预加载资源
      if ('requestIdleCallback' in window) {
        requestIdleCallback(preloadLinks);
      } else {
        setTimeout(preloadLinks, 1000);
      }

      // 添加页面进入动画
      document.addEventListener('DOMContentLoaded', () => {
        const mainContent = document.querySelector('main');
        if (mainContent) {
          mainContent.style.opacity = '0';
          mainContent.style.transform = 'translateY(20px)';
          
          // 使用requestAnimationFrame确保动画流畅
          requestAnimationFrame(() => {
            mainContent.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            mainContent.style.opacity = '1';
            mainContent.style.transform = 'translateY(0)';
          });
        }

        // 检查页面是否包含数学公式，并懒加载 MathJax
        const hasMathFormulas = document.body.textContent?.includes('$') || document.body.textContent?.includes('\\[');
        
        if (hasMathFormulas) {
          // 设置 MathJax 配置
          if (typeof window !== 'undefined') {
            (window as any).MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
              },
              options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                processHtmlClass: 'mathjax-process'
              },
              startup: {
                ready: function() {
                  // 调用 MathJax 的标准初始化
                  (window as any).MathJax.startup.defaultReady();
                  // 初始渲染后再渲染一次，确保所有公式都被处理
                  (window as any).MathJax.typesetPromise();
                }
              }
            };
          }
          
          // 动态加载 MathJax 脚本
          const mathJaxScript = document.createElement('script');
          mathJaxScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js';
          mathJaxScript.defer = true;
          document.head.appendChild(mathJaxScript);
        }

        // 为代码块添加复制按钮、语言标签和行号
        const codeBlocks = document.querySelectorAll('article pre.astro-code');
        codeBlocks.forEach((block) => {
          const codeBlock = block as HTMLElement;
          // 创建复制按钮 - 包含SVG图标
          const copyButton = document.createElement('button');
          copyButton.className = 'copy-button';
          copyButton.setAttribute('aria-label', 'Copy code');
          
          // 添加图标结构
          const iconContainer = document.createElement('div');
          iconContainer.className = 'copy-button-icon';
          
          // 复制图标
          const copyIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          copyIcon.setAttribute('viewBox', '0 -960 960 960');
          copyIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          copyIcon.setAttribute('class', 'copy-button-icon copy-icon');
          const copyPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          copyPath.setAttribute('d', 'M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z');
          copyIcon.appendChild(copyPath);
          
          // 成功图标
          const successIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          successIcon.setAttribute('viewBox', '0 -960 960 960');
          successIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          successIcon.setAttribute('class', 'copy-button-icon success-icon');
          const successPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          successPath.setAttribute('d', 'm389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z');
          successIcon.appendChild(successPath);
          
          iconContainer.appendChild(copyIcon);
          iconContainer.appendChild(successIcon);
          copyButton.appendChild(iconContainer);
          
          // 添加语言标签
          const codeElement = codeBlock.querySelector('code');
          if (codeElement) {
            // 尝试从代码块获取语言信息
            let language = 'code';
            
            // 检查代码块是否有data-language属性
            if (codeBlock.hasAttribute('data-language')) {
              language = codeBlock.getAttribute('data-language') || 'code';
            } 
            // 或者检查class属性
            else if (codeBlock.className) {
              const classMatch = codeBlock.className.match(/language-(\w+)/);
              if (classMatch) {
                language = classMatch[1];
              }
            }
            
            // 创建语言标签元素
            const languageTag = document.createElement('div');
            languageTag.className = 'code-language';
            languageTag.textContent = language;
            
            // 添加到代码块
            codeBlock.appendChild(languageTag);
          }
          
          // 添加到代码块
          codeBlock.appendChild(copyButton);
          
          // 复制功能
          copyButton.addEventListener('click', () => {
            // 获取代码内容
            const codeElement = codeBlock.querySelector('code');
            if (codeElement) {
              // 提取代码文本，去除行号
              let codeText = codeElement.textContent || '';
              
              // 复制到剪贴板
              navigator.clipboard.writeText(codeText).then(() => {
                // 显示复制成功反馈
                copyButton.classList.add('copied');
                
                // 2秒后恢复按钮状态
                setTimeout(() => {
                  copyButton.classList.remove('copied');
                }, 2000);
              }).catch((err) => {
                console.error('复制失败:', err);
                // 可以添加错误处理
              });
            }
          });
          
          // 添加行号
          const lineCodeElement = codeBlock.querySelector('code');
          if (lineCodeElement) {
            const lines = lineCodeElement.querySelectorAll('.line');
            lines.forEach((line: Element, index: number) => {
              // 创建行号元素
              const lineNumber = document.createElement('span');
              lineNumber.className = 'line-number';
              lineNumber.textContent = (index + 1).toString();
              
              // 添加到行前面
              line.insertBefore(lineNumber, line.firstChild);
            });
          }
        });
      });
    </script>
  </body>
</html>